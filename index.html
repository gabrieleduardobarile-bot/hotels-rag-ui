<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hoteles RAG — Consulta</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; line-height: 1.4; }
    h1 { margin: 0 0 12px 0; }
    .card { border: 1px solid #8884; border-radius: 8px; padding: 14px; margin: 12px 0; }
    textarea { width: 100%; min-height: 90px; padding: 10px; box-sizing: border-box; }
    button { padding: 9px 14px; cursor: pointer; }
    .muted { opacity: .8; }
    .status { font-weight: 600; margin-left: 8px; }
    .ok { color: #0a0; }
    .err { color: #a00; white-space: pre-wrap; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #8884; padding: 6px 8px; text-align: left; }
    details { margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Hoteles RAG — Consulta</h1>

  <div class="card">
    <form id="qform">
      <label for="q"><strong>Escribe tu pregunta</strong></label>
      <textarea id="q" placeholder="Ejemplos: 
- Total de habitaciones por país
- Ocupación YTD 2024 por propiedad en Madrid
- Coste total de compras 2023 por hotel y proveedor"></textarea>
      <div style="margin-top:10px; display:flex; gap:10px;">
        <button type="submit">Preguntar</button>
        <button type="button" id="clearBtn">Limpiar</button>
        <span id="status" class="status muted"></span>
      </div>
    </form>
    <p class="muted" style="margin-top:8px;">Este front envía tu pregunta a /api/query del mismo host (vía Nginx). No necesitas configurar nada.</p>
  </div>

  <div class="card">
    <h3>Respuesta</h3>
    <div id="answer" class="muted">Sin consulta.</div>
    <details>
      <summary>Payload enviado</summary>
      <pre id="payload" style="white-space:pre-wrap; overflow:auto; margin:6px 0;">{}</pre>
    </details>
  </div>

  <div class="card">
    <h3>Fuentes</h3>
    <div id="sources" class="muted">Sin fuentes.</div>
  </div>

  <div class="card">
    <h3>Aggregates</h3>
    <div id="agg" class="muted">Sin datos.</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatus(msg, cls="") {
      const el = $("status");
      el.textContent = msg || "";
      el.className = "status " + (cls || "");
    }

    function renderAnswer(text) {
      const el = $("answer");
      el.textContent = text || "Sin respuesta.";
      el.className = text ? "" : "muted";
    }

    function renderPayload(obj) {
      $("payload").textContent = JSON.stringify(obj ?? {}, null, 2);
    }

    function renderSources(list) {
      const box = $("sources");
      if (!Array.isArray(list) || list.length === 0) {
        box.textContent = "Sin fuentes.";
        box.className = "muted";
        return;
      }
      box.className = "";
      box.innerHTML = "";
      const ul = document.createElement("ul");
      list.forEach(s => {
        const li = document.createElement("li");
        const t = s.title || "Fuente";
        const link = s.url || "#";
        const note = s.note ? " — " + s.note : "";
        const a = document.createElement("a");
        a.href = link; a.textContent = t; a.target = "_blank"; a.rel = "noopener";
        li.appendChild(a);
        if (note) li.appendChild(document.createTextNode(note));
        ul.appendChild(li);
      });
      box.appendChild(ul);
    }

    function renderAggregates(rows) {
      const box = $("agg");
      if (!Array.isArray(rows) || rows.length === 0) {
        box.textContent = "Sin datos.";
        box.className = "muted";
        return;
      }
      box.className = "";
      box.innerHTML = "";

      const cols = Object.keys(rows[0] || {});
      if (cols.length === 0) {
        box.textContent = "Sin datos.";
        box.className = "muted";
        return;
      }

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      cols.forEach(c => {
        const th = document.createElement("th");
        th.textContent = c;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      rows.forEach(r => {
        const tr = document.createElement("tr");
        cols.forEach(c => {
          const td = document.createElement("td");
          const v = r[c];
          td.textContent = v == null ? "" : String(v);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      box.appendChild(table);
    }

    // Heurística mínima: mapea texto libre a payloads soportados por el backend
    function buildPayloadFromQuestion(q) {
      const text = (q || "").toLowerCase();

      // 1) Habitaciones por país
      if (text.includes("habitacion") && (text.includes("país") || text.includes("pais"))) {
        return {
          query: q,
          aggregate: { metric: "rooms_total", group_by: ["country"] }
        };
      }

      // 2) Ocupación YTD 2024 por propiedad en <ciudad>
      if ((text.includes("ocup") || text.includes("ytd")) && text.includes("2024")) {
        // intentar extraer ciudad después de "en "
        let city = null;
        const m = q.match(/en\s+([A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+(?:\s+[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+){0,2})/i);
        if (m) city = m[1].trim();
        const payload = { query: q, aggregate: { group_by: ["property"] } };
        if (city) payload.filters = { city: city, year: 2024 };
        else payload.filters = { year: 2024 };
        return payload;
      }

      // 3) Compras 2023 por hotel y proveedor
      if (text.includes("compra") && text.includes("2023")) {
        return {
          query: q,
          filters: { year: 2023 },
          aggregate: { metric: "importe_total", group_by: ["property","proveedor"] }
        };
      }

      // Por defecto (solo query)
      return { query: q };
    }

    async function getJSON(url, opts) {
      const res = await fetch(url, opts);
      if (!res.ok) {
        const t = await res.text().catch(()=>"");
        throw new Error("HTTP " + res.status + " " + t);
      }
      return res.json();
    }

    async function ask(q) {
      const payload = buildPayloadFromQuestion(q);
      renderPayload(payload);
      renderAnswer("Consultando...");
      $("agg").textContent = "Sin datos.";
      $("agg").className = "muted";
      $("sources").textContent = "Sin fuentes.";
      $("sources").className = "muted";
      setStatus("Enviando…", "");

      try {
        const data = await getJSON("/api/query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        renderAnswer(data.answer || "Sin 'answer'.");
        renderAggregates(Array.isArray(data.aggregates) ? data.aggregates : []);
        renderSources(Array.isArray(data.sources) ? data.sources : []);
        setStatus("OK", "ok");
      } catch (e) {
        setStatus("Error al consultar /api/query", "err");
        renderAnswer("Error al consultar /api/query.");
        console.error(e);
      }
    }

    window.addEventListener("DOMContentLoaded", () => {
      $("qform").addEventListener("submit", (ev) => {
        ev.preventDefault();
        const q = $("q").value.trim();
        if (!q) { setStatus("Escribe una pregunta", "err"); return; }
        ask(q);
      });
      $("clearBtn").addEventListener("click", () => {
        $("q").value = "";
        renderPayload({});
        renderAnswer("Sin consulta.");
        $("agg").textContent = "Sin datos."; $("agg").className = "muted";
        $("sources").textContent = "Sin fuentes."; $("sources").className = "muted";
        setStatus("", "");
      });
    });
  </script>
</body>
</html>
